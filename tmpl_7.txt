                                    const chartsHtml = `
                                        <div class="charts-container" id="charts-${utilityId}">
                                            <div style="text-align: center; font-weight: bold; margin-bottom: 10px;">
                                                ðŸ“ˆ Real-time Monitoring Charts
                                            </div>
                                            <div class="charts-grid">
                                                <div class="chart-section">
                                                    <div class="chart-title voltage">âš¡ Voltage</div>
                                                    <div class="chart-canvas">
                                                        <canvas id="voltage-chart-${utilityId}"></canvas>
                                                    </div>
                                                </div>
                                                <div class="chart-section">
                                                    <div class="chart-title current">ðŸ”Œ Current</div>
                                                    <div class="chart-canvas">
                                                        <canvas id="current-chart-${utilityId}"></canvas>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                    registersContainer.insertAdjacentHTML('afterend', chartsHtml);
                                    
                                    // Reinitialize charts
                                    setTimeout(() => {
                                        initializeCharts(utilityId);
                                    }, 100);
                                }
                            } else {
                                // Charts exist, check if chart instances are still valid
                                const voltageCanvas = document.getElementById(`voltage-chart-${utilityId}`);
                                const currentCanvas = document.getElementById(`current-chart-${utilityId}`);
                                
                                if (voltageCanvas && (!chartInstances[utilityId] || !chartInstances[utilityId].voltage)) {
                                    console.log(`Voltage chart instance missing for ${utilityId}, reinitializing...`);
                                    setTimeout(() => {
                                        initializeCharts(utilityId);
                                    }, 100);
                                } else if (currentCanvas && (!chartInstances[utilityId] || !chartInstances[utilityId].current)) {
                                    console.log(`Current chart instance missing for ${utilityId}, reinitializing...`);
                                    setTimeout(() => {
                                        initializeCharts(utilityId);
                                    }, 100);
                                }
                            }
                        }
                    } else {
                        // Update just this utility in the UI (full card replacement)
                        const utilityCard = document.getElementById(`utility-${utilityId}`);
                        if (utilityCard) {
                            const newCardHtml = createUtilityCard(utilityId, data.utility_data);
                            utilityCard.outerHTML = newCardHtml;
                        }
                    }
                } else {
                    // Check if this is a configuration issue
                    if (data.suggestion === 'reload_config') {
                        showError(`${data.error} Click "Refresh All" to reload configuration.`);
                    } else {
                        showError(`Failed to refresh utility: ${data.error || 'Unknown error'}`);
                    }
                }
                
            } catch (error) {
                console.error('Error refreshing utility:', error);
                showError('Error occurred while refreshing utility');
            } finally {
                if (button) {
                    button.disabled = false;
                    button.className = 'refresh-btn';
                    button.textContent = 'ðŸ”„ Refresh';
                }
            }
        }

        function toggleMonitoring(utilityId, button) {
            if (button.disabled) return;
            
            const isCurrentlyMonitoring = monitoringIntervals.hasOwnProperty(utilityId);
            
            if (isCurrentlyMonitoring) {
                // Stop monitoring
                clearInterval(monitoringIntervals[utilityId]);
                delete monitoringIntervals[utilityId];
                
                button.className = 'monitor-toggle';
                button.textContent = 'ðŸ”´ Monitor';
                button.title = 'Start continuous monitoring (2s)';
                
                // Remove monitor status
                const utilityCard = document.getElementById(`utility-${utilityId}`);
                const monitorStatus = utilityCard.querySelector('.monitor-status');
                if (monitorStatus) {
                    monitorStatus.remove();
                }

                // Remove charts
                const chartsContainer = document.getElementById(`charts-${utilityId}`);
                if (chartsContainer) {
                    chartsContainer.remove();
                }

                // Clean up chart instances
                if (chartInstances[utilityId]) {
                    if (chartInstances[utilityId].voltage) {
                        chartInstances[utilityId].voltage.destroy();
                    }
                    if (chartInstances[utilityId].current) {
                        chartInstances[utilityId].current.destroy();
                    }
                    delete chartInstances[utilityId];
                }

                // Clear chart data
                delete chartData[utilityId];
                
                console.log(`Stopped monitoring utility: ${utilityId}`);
                
            } else {
                // Start monitoring
                button.className = 'monitor-toggle active';
                button.textContent = 'ðŸ›‘ Stop';
                button.title = 'Stop continuous monitoring';
                
                // Add monitor status
                const utilityInfo = document.querySelector(`#utility-${utilityId} .utility-info`);
                if (utilityInfo && !utilityInfo.querySelector('.monitor-status')) {
                    const monitorStatus = document.createElement('div');
                    monitorStatus.className = 'monitor-status';
                    monitorStatus.textContent = 'ðŸ”´ Live Monitoring Active (2s)';
                    utilityInfo.appendChild(monitorStatus);
                }

                // Add charts container
                const utilityCard = document.getElementById(`utility-${utilityId}`);
                const registersContainer = utilityCard.querySelector('.registers-container');
                if (registersContainer && !document.getElementById(`charts-${utilityId}`)) {
                    const chartsHtml = `
                        <div class="charts-container" id="charts-${utilityId}">
                            <div style="text-align: center; font-weight: bold; margin-bottom: 10px;">
                                ðŸ“ˆ Real-time Monitoring Charts
                            </div>
                            <div class="charts-grid">
                                <div class="chart-section">
                                    <div class="chart-title voltage">âš¡ Voltage</div>
                                    <div class="chart-canvas">
                                        <canvas id="voltage-chart-${utilityId}"></canvas>
                                    </div>
                                </div>
                                <div class="chart-section">
                                    <div class="chart-title current">ðŸ”Œ Current</div>
                                    <div class="chart-canvas">
                                        <canvas id="current-chart-${utilityId}"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    registersContainer.insertAdjacentHTML('afterend', chartsHtml);
                }

                // Initialize charts (clear any existing data)
                clearCharts(utilityId);
                setTimeout(() => {
                    initializeCharts(utilityId);
                }, 100);
                
                // Start interval for continuous monitoring
                monitoringIntervals[utilityId] = setInterval(async () => {
                    try {
                        await refreshUtility(utilityId, null); // Don't pass button to avoid UI changes
                    } catch (error) {
                        console.error(`Error in continuous monitoring for ${utilityId}:`, error);
                    }
                }, 2000); // 2 second interval
                
                console.log(`Started continuous monitoring for utility: ${utilityId}`);
            }
            
            // Update monitoring count in status bar
            updateMonitoringCount();
        }

        function updateMonitoringCount() {
            const monitoringCount = Object.keys(monitoringIntervals).length;
            const countElement = document.getElementById('monitoringCount');
            if (countElement) {
                countElement.textContent = `Live Monitoring: ${monitoringCount}`;
                countElement.style.color = monitoringCount > 0 ? '#e74c3c' : '#7f8c8d';
                countElement.style.fontWeight = monitoringCount > 0 ? 'bold' : 'normal';
            }
        }

        function showError(message) {
            const grid = document.getElementById('utilitiesGrid');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            
            // Insert at the top
