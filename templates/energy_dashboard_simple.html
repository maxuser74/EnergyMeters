<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Energy Meter Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #0f172a; color: #e5e7eb; min-height: 100vh; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; background: #111827; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.4); overflow: hidden; }
        .header { background: linear-gradient(135deg, #0b1220 0%, #1f2937 100%); color: #f3f4f6; padding: 20px 30px; text-align: center; }
        .header h1 { font-size: 2.0em; margin-bottom: 6px; }
        .status-bar { background: #0b1220; padding: 12px 20px; border-bottom: 1px solid #1f2937; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .status-item { display: flex; align-items: center; gap: 10px; }
        .status-indicator { width: 12px; height: 12px; border-radius: 50%; background: #ef4444; }
        .status-indicator.connected { background: #10b981; }
        .refresh-all-btn { background: #2563eb; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600; }
        .utilities-grid { padding: 20px; }
        .utility-card { background: #0b1220; border: 1px solid #1f2937; border-radius: 10px; margin-bottom: 18px; box-shadow: 0 2px 10px rgba(0,0,0,0.3); }
        .utility-header { background: #111827; padding: 14px 16px; border-bottom: 1px solid #1f2937; display: flex; justify-content: space-between; align-items: center; }
        .utility-info h3 { color: #f3f4f6; font-size: 1.1em; margin-bottom: 4px; }
        .utility-details { color: #9ca3af; font-size: 0.9em; }
        .monitor-toggle { background: #6b7280; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-weight: 600; }
        .monitor-toggle.active { background: #ef4444; }
        .refresh-btn { background: #059669; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-weight: 600; margin-right: 8px; }
        .monitor-status { font-size: 0.85em; color: #f87171; font-weight: bold; margin-top: 6px; }
        .registers-container { padding: 12px 16px; }
        .registers-grid { display: flex; flex-wrap: nowrap; gap: 10px; overflow-x: auto; }
        .register-badge { background: #111827; border: 1px solid #1f2937; padding: 8px 10px; border-radius: 8px; text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .register-name { font-weight: 600; color: #e5e7eb; font-size: 0.75em; margin-bottom: 4px; }
        .register-measure { display: flex; align-items: baseline; gap: 6px; }
        .register-value { font-size: 1.2em; font-weight: 700; }
        .register-unit { font-size: 0.85em; color: #9ca3af; }
        .no-data { text-align: center; color: #9ca3af; padding: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Energy Meter Dashboard</h1>
            <p>Real-time monitoring of energy meters from Excel configuration</p>
        </div>

        <div class="status-bar">
            <div class="status-item"><div class="status-indicator" id="connectionIndicator"></div><span id="connectionStatus">Connecting...</span></div>
            <div class="status-item"><span id="lastUpdate">Last Update: Loading...</span></div>
            <div class="status-item"><span id="utilitiesCount">Utilities: 0</span></div>
            <div class="status-item"><span id="monitoringCount">Live Monitoring: 0</span></div>
            <div class="status-item"><label for="monitorIntervalInput">Polling (ms):</label> <input id="monitorIntervalInput" type="number" min="50" step="50" style="width: 90px; padding: 4px;" /></div>
            <button class="refresh-all-btn" id="refreshAllBtn" onclick="refreshAll()">üîÑ Refresh All</button>
        </div>

        <div class="utilities-grid" id="utilitiesGrid">
            <div class="no-data"><h3>Loading utilities...</h3><p>Please wait while we load the configuration from Excel files.</p></div>
        </div>
    </div>

    <script>
        let isRefreshing = false;
        let monitoringIntervals = {};
        let autoStartMonitoring = true;
        let didAutoStartMonitoring = false;
        let monitorIntervalMs = Number(localStorage.getItem('monitorIntervalMs') || {{ monitor_interval_ms|default(500) }});
        const intervalInput = document.getElementById('monitorIntervalInput');
        intervalInput.value = monitorIntervalMs;
        intervalInput.addEventListener('change', () => {
            const v = Math.max(50, Number(intervalInput.value) || {{ monitor_interval_ms|default(500) }});
            monitorIntervalMs = v;
            localStorage.setItem('monitorIntervalMs', String(v));
            restartAllMonitoringIntervals();
            updateMonitorStatusLabels();
        });

        document.addEventListener('DOMContentLoaded', function() { refreshAll(); });
        window.addEventListener('beforeunload', () => { Object.values(monitoringIntervals).forEach(interval => clearInterval(interval)); });

        function restartAllMonitoringIntervals() {
            Object.keys(monitoringIntervals).forEach(utilityId => {
                clearInterval(monitoringIntervals[utilityId]);
                monitoringIntervals[utilityId] = setInterval(async () => { try { await refreshUtility(utilityId, null); } catch (e) {} }, monitorIntervalMs);
            });
        }
        function updateMonitorStatusLabels() {
            document.querySelectorAll('.monitor-status').forEach(el => { el.textContent = `üî¥ Live Monitoring Active (${monitorIntervalMs} ms)`; });
            document.querySelectorAll('.monitor-toggle').forEach(btn => { if (!btn.classList.contains('active')) btn.title = `Start continuous monitoring (${monitorIntervalMs} ms)`; });
        }

        async function refreshAll() {
            if (isRefreshing) return; isRefreshing = true; const btn = document.getElementById('refreshAllBtn'); if (btn) { btn.disabled = true; btn.textContent = 'üîÑ Reloading Config & Refreshing...'; }
            try {
                const resp = await fetch('/api/refresh_all');
                const data = await resp.json();
                if (data.success) updateUI({ readings: data.readings, last_update: data.timestamp, connection_status: `Connected (${data.utilities_count}/${data.utilities_count} utilities)` });
            } catch(e) { console.error(e); } finally { isRefreshing = false; if (btn) { btn.disabled = false; btn.textContent = 'üîÑ Refresh All'; } }
        }

        function getStatusClass(status) { if (status === 'OK') return 'status-ok'; if (status === 'PARTIAL') return 'status-partial'; return 'status-error'; }
        function createRegisterBadge(reg, category) {
            const badgeClass = reg.status === 'OK' ? category : 'error';
            const valueClass = reg.status === 'OK' ? '' : 'error';
            return `<div class="register-badge ${badgeClass}"><div class="register-name">${reg.description}</div><div class="register-measure"><span class="register-value ${valueClass}">${reg.value}</span><span class="register-unit">${reg.unit || ''}</span></div></div>`;
        }
        function renderSingleRow(utilityData) {
            const regs = Object.values(utilityData.registers || {});
            let totalKW = 0;
            regs.forEach(r => {
                const val = parseFloat(r.value);
                if (!isNaN(val) && r.status === 'OK') {
                    const unit = (r.unit || '').toLowerCase();
                    const cat = (r.category || '').toLowerCase();
                    const desc = (r.description || '').toLowerCase();
                    const isActivePower = (cat.includes('power') && !cat.includes('factor')) || (desc.includes('active') && desc.includes('power'));
                    const isEnergy = cat.includes('energy') || unit.includes('wh');
                    if (!isEnergy && isActivePower) {
                        if (unit.includes('kw')) totalKW += val; else if (unit.includes('w')) totalKW += (val / 1000.0);
                    }
                }
            });
            const grouped = { current: [], power_factor: [], voltage: [], other: [] };
            regs.forEach(r => { const c=(r.category||'other').toLowerCase(); if (c.includes('current')) grouped.current.push(r); else if (c.includes('power_factor')||c==='pf'||c==='cosphi') grouped.power_factor.push(r); else if (c.includes('voltage')) grouped.voltage.push(r); else grouped.other.push(r); });
            let html = '<div class="registers-container"><div class="registers-grid">';
            if (totalKW > 0) html += `<div class="register-badge energy" data-category="total_active_power"><div class="register-name">Total Active Power</div><div class="register-measure"><span class="register-value">${totalKW.toFixed(3)}</span><span class="register-unit">kW</span></div></div>`;
            grouped.current.forEach(r => { html += createRegisterBadge(r, 'current'); });
            grouped.power_factor.forEach(r => { html += createRegisterBadge(r, 'power_factor'); });
            grouped.voltage.forEach(r => { html += createRegisterBadge(r, 'voltage'); });
            grouped.other.forEach(r => { html += createRegisterBadge(r, 'other'); });
            html += '</div></div>'; return html;
        }
        function updateUI(data) {
            const indicator = document.getElementById('connectionIndicator'); const status = document.getElementById('connectionStatus'); const lastUpdate = document.getElementById('lastUpdate');
            if (data.connection_status && data.connection_status.includes('Connected')) { indicator.className='status-indicator connected'; status.textContent=data.connection_status; } else { indicator.className='status-indicator'; status.textContent=data.connection_status||'Disconnected'; }
            lastUpdate.textContent = `Last Update: ${data.last_update || 'Never'}`;
            const grid = document.getElementById('utilitiesGrid');
            if (!data.readings || Object.keys(data.readings).length === 0) { grid.innerHTML = `<div class=\"no-data\"><h3>No data available</h3><p>Polling devices... Please wait.</p></div>`; return; }
            let html = '';
            for (const [utilityId, utilityData] of Object.entries(data.readings)) {
                const statusClass = getStatusClass(utilityData.status);
                const isMonitoring = monitoringIntervals.hasOwnProperty(utilityId);
                html += `<div class=\"utility-card\" id=\"utility-${utilityId}\"><div class=\"utility-header\"><div class=\"utility-info\"><h3>${utilityData.name}</h3><div class=\"utility-details\">Cabinet ${utilityData.cabinet} | Node ${utilityData.node} | ${utilityData.ip_address}</div><div class=\"utility-status ${statusClass}\">${utilityData.status}</div><div class=\"timestamp\">${utilityData.timestamp || ''}</div>${isMonitoring ? '<div class=\"monitor-status\">üî¥ Live Monitoring Active (' + monitorIntervalMs + ' ms)</div>' : ''}</div><div class=\"utility-header-actions\"><button class=\"refresh-btn\" onclick=\"refreshUtility('${utilityId}', this)\">üîÑ Refresh</button><button class=\"monitor-toggle ${isMonitoring ? 'active' : ''}\" onclick=\"toggleMonitoring('${utilityId}', this)\" title=\"${isMonitoring ? 'Stop continuous monitoring' : 'Start continuous monitoring (' + monitorIntervalMs + ' ms)'}\">${isMonitoring ? '‚èπ Stop' : 'üî¥ Monitor'}</button></div></div>${renderSingleRow(utilityData)}</div>`;
            }
            grid.innerHTML = html;
            if (autoStartMonitoring && !didAutoStartMonitoring && data && data.readings) { Object.keys(data.readings).forEach(utilityId => { const btn=document.querySelector(`#utility-${utilityId} .monitor-toggle`); if (btn && !monitoringIntervals.hasOwnProperty(utilityId)) toggleMonitoring(utilityId, btn); }); didAutoStartMonitoring = true; }
            updateMonitoringCount();
        }
        async function refreshUtility(utilityId, button) { if (button) { button.disabled=true; button.textContent='üîÑ Loading...'; } try { const r=await fetch(`/api/refresh_utility/${utilityId}`); const d=await r.json(); if (d.success) { const rr=await fetch('/api/readings'); const all=await rr.json(); updateUI(all); } } catch(e) { console.error(e); } finally { if (button) { button.disabled=false; button.textContent='üîÑ Refresh'; } } }
        function toggleMonitoring(utilityId, button) { const active=monitoringIntervals.hasOwnProperty(utilityId); const card=document.getElementById(`utility-${utilityId}`); const info=card?card.querySelector('.utility-info'):null; if (active) { clearInterval(monitoringIntervals[utilityId]); delete monitoringIntervals[utilityId]; if (button) { button.className='monitor-toggle'; button.textContent='üî¥ Monitor'; button.title=`Start continuous monitoring (${monitorIntervalMs} ms)`; } const ms=card.querySelector('.monitor-status'); if (ms) ms.remove(); } else { if (button) { button.className='monitor-toggle active'; button.textContent='‚èπ Stop'; button.title='Stop continuous monitoring'; } if (info && !info.querySelector('.monitor-status')) { const ms=document.createElement('div'); ms.className='monitor-status'; ms.textContent='üî¥ Live Monitoring Active (' + monitorIntervalMs + ' ms)'; info.appendChild(ms); } monitoringIntervals[utilityId] = setInterval(async()=>{ try{ await refreshUtility(utilityId, null);}catch(e){} }, monitorIntervalMs); } updateMonitoringCount(); }
        function updateMonitoringCount() { const n=Object.keys(monitoringIntervals).length; const el=document.getElementById('monitoringCount'); if (el){ el.textContent=`Live Monitoring: ${n}`; el.style.color= n>0 ? '#e74c3c':'#7f8c8d'; el.style.fontWeight = n>0 ? 'bold':'normal'; } }
    </script>
</body>
</html>

