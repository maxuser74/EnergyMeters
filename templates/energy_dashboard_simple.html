<!DOCTYPE html>
<html lang="en" class="dark h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="color-scheme" content="dark light" />
  <title>Energy Meter Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { darkMode: 'class', theme: { extend: {} } }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="min-h-screen bg-slate-950 text-slate-200 antialiased">
  <div class="max-w-7xl mx-auto my-6 bg-slate-900 rounded-xl shadow-2xl overflow-hidden">
    <header class="bg-gradient-to-r from-slate-900 to-slate-800 px-6 py-5 text-center">
      <h1 class="text-2xl font-semibold">Energy Meter Dashboard</h1>
      <p class="text-slate-400 text-sm mt-1">Real-time monitoring of energy meters from Excel configuration</p>
    </header>

    <section class="flex flex-wrap items-center justify-between gap-3 bg-slate-950/60 border-b border-slate-800 px-4 py-3">
      <div class="flex items-center gap-2 text-sm">
        <span id="connectionIndicator" class="w-3 h-3 rounded-full bg-red-500"></span>
        <span id="connectionStatus" class="text-slate-300">Connecting...</span>
      </div>
      <div id="lastUpdate" class="text-sm text-slate-400">Last Update: Loading...</div>
      <div id="utilitiesCount" class="text-sm text-slate-400">Utilities: 0</div>
      <div class="text-sm text-slate-400">Source: registri.xlsx</div>
    </section>

    <main id="utilitiesGrid" class="p-5">
      <div class="text-center text-slate-400 py-8">
        <h3 class="font-medium text-slate-200">Loading utilities...</h3>
        <p>Please wait while we load the configuration from Excel files.</p>
      </div>
    </main>
  </div>

  <script>
    const AUTO_REFRESH_MS = 5000;
    let isRefreshing = false;
    let autoRefreshTimer = null;

    document.addEventListener('DOMContentLoaded', () => {
      refreshAll();
      autoRefreshTimer = setInterval(refreshAll, AUTO_REFRESH_MS);
    });

    window.addEventListener('beforeunload', () => {
      if (autoRefreshTimer) clearInterval(autoRefreshTimer);
    });

    function createRegisterBadge(reg, category) {
      const ok = reg.status === 'OK' || reg.status === undefined;
      const palette = ok ? 'border-slate-700 bg-slate-800' : 'border-red-700 bg-red-900/40';
      const name = reg.title || reg.description || '';
      const value = (reg.value !== undefined && reg.value !== null) ? reg.value : 'N/A';
      const unit = reg.unit || '';
      return `
        <div class="register-badge ${category} inline-flex w-full flex-col items-center justify-center rounded-lg border ${palette} px-3 py-2 text-center">
          <div class="register-name text-slate-200 text-xs font-semibold mb-1">${name}</div>
          <div class="register-measure flex items-baseline gap-1">
            <span class="register-value text-slate-100 text-base font-bold">${value}</span>
            <span class="register-unit text-slate-400 text-xs">${unit}</span>
          </div>
        </div>
      `;
    }

    function renderSingleRow(utilityData) {
      const regs = Object.values(utilityData.registers || {});
      const textOf = (r) => (r.title || r.description || '').toLowerCase();
      const findByDesc = (substr) => regs.find(r => textOf(r).includes(substr));
      const rendered = new Set();

      const pfs = regs.filter(r => {
        const c = (r.category || '').toLowerCase();
        const d = textOf(r);
        return c.includes('power_factor') || c === 'pf' || c === 'cosphi' || d.includes('power factor');
      });
      const pfL1 = pfs.find(r => textOf(r).includes('l1'));
      const pfL2 = pfs.find(r => textOf(r).includes('l2'));
      const pfL3 = pfs.find(r => textOf(r).includes('l3'));

      const cells = [];
      if (pfL1) { cells.push(createRegisterBadge(pfL1, 'power_factor')); rendered.add(pfL1.description); }
      if (pfL2) { cells.push(createRegisterBadge(pfL2, 'power_factor')); rendered.add(pfL2.description); }
      if (pfL3) { cells.push(createRegisterBadge(pfL3, 'power_factor')); rendered.add(pfL3.description); }

      const energyReg = findByDesc('positive active energy three phases');
      if (energyReg && !rendered.has(energyReg.description)) {
        cells.push(createRegisterBadge(energyReg, 'energy'));
        rendered.add(energyReg.description);
      }

      regs
        .filter(r => !rendered.has(r.description))
        .sort((a, b) => (String(a.category || '').localeCompare(String(b.category || '')) ||
                         String(a.description || '').localeCompare(String(b.description || ''))))
        .forEach(r => {
          cells.push(createRegisterBadge(r, r.category || 'other'));
          rendered.add(r.description);
        });

      let html = '<div class="registers-container overflow-x-auto"><div class="registers-row flex flex-row items-stretch gap-3 min-w-max">';
      html += cells.join('');
      html += '</div></div>';
      return html;
    }

    function mapStatus(status) {
      if (status === 'OK') return { label: 'OK', className: 'text-emerald-400' };
      return { label: 'NO', className: 'text-red-400' };
    }

    async function refreshAll() {
      if (isRefreshing) return;
      isRefreshing = true;
      try {
        const resp = await fetch('/api/refresh_all');
        const data = await resp.json();
        if (!resp.ok || !data.success) {
          console.error('Failed to refresh', data.error || resp.statusText);
          return;
        }

        const okCount = Object.values(data.readings || {}).filter(u => u.status === 'OK' || u.status === 'PARTIAL').length;
        const total = Object.keys(data.readings || {}).length;
        const connectionText = total === 0
          ? 'No utilities configured'
          : (okCount > 0 ? `Connected (${okCount}/${total} utilities)` : 'All connections failed');

        updateUI({
          readings: data.readings,
          last_update: data.timestamp,
          connection_status: connectionText,
          utilities_count: total
        });
      } catch (error) {
        console.error('Error refreshing all utilities', error);
      } finally {
        isRefreshing = false;
      }
    }

    function updateUI(data) {
      const indicator = document.getElementById('connectionIndicator');
      const status = document.getElementById('connectionStatus');
      const lastUpdate = document.getElementById('lastUpdate');
      const utilitiesCount = document.getElementById('utilitiesCount');

      if (data.connection_status && data.connection_status.toLowerCase().includes('connected')) {
        indicator.classList.remove('bg-red-500');
        indicator.classList.add('bg-emerald-500');
      } else {
        indicator.classList.remove('bg-emerald-500');
        indicator.classList.add('bg-red-500');
      }
      status.textContent = data.connection_status || 'Disconnected';
      lastUpdate.textContent = `Last Update: ${data.last_update || 'Never'}`;
      utilitiesCount.textContent = `Utilities: ${data.utilities_count ?? 0}`;

      const grid = document.getElementById('utilitiesGrid');
      if (!data.readings || Object.keys(data.readings).length === 0) {
        grid.innerHTML = '<div class="text-center text-slate-400 py-8"><h3 class="font-medium text-slate-200">No data available</h3><p>Polling devices... Please wait.</p></div>';
        return;
      }

      let html = '';
      let visibleCount = 0;
      for (const [utilityId, utilityData] of Object.entries(data.readings)) {
        try {
          const { label: statusLabel, className: statusClass } = mapStatus(utilityData.status);
          if (statusLabel === 'NO') {
            continue;
          }
          const infoText = `${utilityData.name}, Cabinet ${utilityData.cabinet} | Node ${utilityData.node} | ${utilityData.ip_address}, `;
          const timestampFragment = utilityData.timestamp ? `, ${utilityData.timestamp}` : '';

          html += `
            <div class="bg-slate-900 border border-slate-800 rounded-xl shadow mb-4" id="utility-${utilityId}">
              <div class="bg-slate-800/80 border-b border-slate-800 px-4 py-3">
                <div class="utility-info text-slate-300 text-sm flex flex-wrap items-center gap-x-1 gap-y-1">
                  <span class="font-semibold text-slate-100">${infoText}</span>
                  <span class="${statusClass} font-semibold">${statusLabel}</span>
                  <span class="text-slate-300">${timestampFragment}</span>
                </div>
              </div>
              ${renderSingleRow(utilityData)}
            </div>`;
          visibleCount += 1;
        } catch (err) {
          console.error(`Failed to render utility ${utilityId}`, err);
          continue;
        }
      }
      if (visibleCount === 0) {
        grid.innerHTML = '<div class="text-center text-slate-400 py-8"><h3 class="font-medium text-slate-200">No healthy utilities</h3><p>Waiting for devices to become available...</p></div>';
      } else {
        grid.innerHTML = html;
      }
    }
  </script>
</body>
</html>
