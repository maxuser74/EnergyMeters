                    <div class="utility-header">
                        <div class="utility-info">
                            <h3>${utilityData.name}</h3>
                            <div class="utility-details">
                                Cabinet ${utilityData.cabinet} | Node ${utilityData.node} | ${utilityData.ip_address}
                            </div>
                            <div class="utility-status ${statusClass}">
                                ${utilityData.status}
                            </div>
                            <div class="timestamp">
                                ${utilityData.timestamp || ''}
                            </div>
                            ${isMonitoring ? '<div class="monitor-status">ðŸ”´ Live Monitoring Active (2s)</div>' : ''}
                        </div>
                        <div class="utility-header-actions">
                            <button class="refresh-btn" onclick="refreshUtility('${utilityId}', this)">
                                ðŸ”„ Refresh
                            </button>
                            <button class="monitor-toggle ${isMonitoring ? 'active' : ''}" 
                                    onclick="toggleMonitoring('${utilityId}', this)"
                                    title="${isMonitoring ? 'Stop continuous monitoring' : 'Start continuous monitoring (2s)'}">
                                ${isMonitoring ? 'ðŸ›‘ Stop' : 'ðŸ”´ Monitor'}
                            </button>
                        </div>
                    </div>
                    ${registersHtml}
                </div>
            `;
        }

        function createRegisterBadge(regData, category) {
            const badgeClass = regData.status === 'OK' ? category : 'error';
            const valueClass = regData.status === 'OK' ? '' : 'error';
            // Add data-category for dynamic coloring
            let dataAttr = '';
            if (regData.status === 'OK' && !['voltage','current','energy','other'].includes(category)) {
                dataAttr = `data-category="${category}"`;
            }
            // Show the type/category in the badge for clarity
            let typeLabel = '';
            if (regData.category && regData.category !== category) {
                typeLabel = `<div class='register-type'>${regData.category.replace(/_/g, ' ').replace(/\w/g, l => l.toUpperCase())}</div>`;
            }
            return `
                <div class="register-badge ${badgeClass}" ${dataAttr}>
                    ${typeLabel}
                    <div class="register-name">${regData.description}</div>
                    <div class="register-measure">
                        <span class="register-value ${valueClass}">${regData.value}</span>
                        <span class="register-unit">${regData.unit || ''}</span>
                    </div>
                </div>
            `;
        }

        // Dynamic coloring for unknown categories using HSL hash
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                document.querySelectorAll('.register-badge[data-category]').forEach(badge => {
                    const cat = badge.getAttribute('data-category');
                    if (!badge.classList.contains('frequency') && !badge.classList.contains('temperature') && !badge.classList.contains('power_factor')) {
                        // Hash category name to HSL color
                        let hash = 0;
                        for (let i = 0; i < cat.length; i++) hash = cat.charCodeAt(i) + ((hash << 5) - hash);
                        const hue = Math.abs(hash) % 360;
                        badge.style.borderColor = `hsl(${hue},70%,50%)`;
                        badge.style.background = `linear-gradient(135deg, hsl(${hue},100%,98%), hsl(${hue},100%,92%))`;
                    }
                });
            }, 100);
        });

        function getStatusClass(status) {
            if (status === 'OK') return 'status-ok';
            if (status === 'PARTIAL') return 'status-partial';
            return 'status-error';
        }

        async function refreshAll() {
            if (isRefreshing) return;
            
            isRefreshing = true;
            const btn = document.getElementById('refreshAllBtn');
            btn.disabled = true;
            btn.textContent = 'ðŸ”„ Reloading Config & Refreshing...';
            
            try {
                const response = await fetch('/api/refresh_all');
                const data = await response.json();
                
                if (data.success) {
                    // Update utilities count if configuration changed
                    if (data.utilities_count !== undefined && data.registers_count !== undefined) {
                        document.getElementById('utilitiesCount').textContent = 
                            `Utilities: ${data.utilities_count} | Registers: ${data.registers_count}`;
                    }
                    
                    // Show configuration reload message with changes if provided
                    if (data.message) {
                        console.log('Configuration reloaded:', data.message);
                        let message = data.message;
                        if (data.changes && data.changes !== "No changes detected") {
                            message += `
Changes: ${data.changes}`;
                        }
                        showSuccess(message);
                    }
                    
                    // Log specific changes to console for debugging
                    if (data.added_utilities && data.added_utilities.length > 0) {
                        console.log('Added utilities:', data.added_utilities);
                    }
                    if (data.removed_utilities && data.removed_utilities.length > 0) {
                        console.log('Removed utilities:', data.removed_utilities);
                    }
                    
                    updateUI({
                        readings: data.readings,
                        last_update: data.timestamp,
                        connection_status: 'Configuration reloaded and refreshed',
                        utilities_count: data.utilities_count,
                        registers_count: data.registers_count
                    });
                } else {
                    showError(`Failed to refresh: ${data.error || 'Unknown error'}`);
                }
                
            } catch (error) {
                console.error('Error refreshing all:', error);
                showError('Error occurred while refreshing all utilities');
            } finally {
                isRefreshing = false;
                btn.disabled = false;
                btn.textContent = 'ðŸ”„ Refresh All';
            }
        }

        async function refreshUtility(utilityId, button) {
            if (button && button.disabled) return;
            
            if (button) {
                button.disabled = true;
                button.className = 'refresh-btn loading';
                button.textContent = 'ðŸ”„ Loading...';
            }
            
            try {
                const response = await fetch(`/api/refresh_utility/${utilityId}`);
                const data = await response.json();
                
                if (data.success) {
                    const isMonitoring = monitoringIntervals.hasOwnProperty(utilityId);
                    
                    if (isMonitoring) {
                        // If monitoring is active, update charts and register values only
                        updateCharts(utilityId, data.utility_data);
                        
                        // Update register values in the existing card
                        const utilityCard = document.getElementById(`utility-${utilityId}`);
                        if (utilityCard && data.utility_data.registers) {
                            Object.entries(data.utility_data.registers).forEach(([regKey, regData]) => {
                                // Update register badges
                                const registerBadges = utilityCard.querySelectorAll('.register-badge');
                                registerBadges.forEach(badge => {
                                    const nameElement = badge.querySelector('.register-name');
                                    if (nameElement && nameElement.textContent.trim() === regData.description) {
                                        const valueElement = badge.querySelector('.register-value');
                                        const unitElement = badge.querySelector('.register-unit');
                                        
                                        if (valueElement) {
                                            valueElement.textContent = regData.value;
                                            valueElement.className = regData.status === 'OK' ? 'register-value' : 'register-value error';
                                        }
                                        if (unitElement) {
                                            unitElement.textContent = regData.unit || '';
                                        }
                                    }
                                });
                            });
                            
                            // Update utility status
                            const statusElement = utilityCard.querySelector('.utility-status');
                            if (statusElement) {
                                statusElement.textContent = data.utility_data.status;
                                statusElement.className = `utility-status ${getStatusClass(data.utility_data.status)}`;
                            }
                            
                            // Update timestamp
                            const timestampElement = utilityCard.querySelector('.timestamp');
                            if (timestampElement) {
                                timestampElement.textContent = data.utility_data.timestamp || '';
                            }

                            // Ensure charts are still present and functioning
                            const chartsContainer = document.getElementById(`charts-${utilityId}`);
                            if (!chartsContainer) {
                                // Charts container is missing, recreate it
                                console.log(`Charts missing for ${utilityId}, recreating...`);
                                const registersContainer = utilityCard.querySelector('.registers-container');
                                if (registersContainer) {
