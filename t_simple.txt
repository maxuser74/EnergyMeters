<!DOCTYPE html>
<html lang="en" class="dark h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="color-scheme" content="dark light" />
  <title>Energy Meter Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { darkMode: 'class', theme: { extend: {} } }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="min-h-screen bg-slate-950 text-slate-200 antialiased">
  <div class="max-w-7xl mx-auto my-6 bg-slate-900 rounded-xl shadow-2xl overflow-hidden">
    <header class="bg-gradient-to-r from-slate-900 to-slate-800 px-6 py-5 text-center">
      <h1 class="text-2xl font-semibold">Energy Meter Dashboard</h1>
      <p class="text-slate-400 text-sm mt-1">Real-time monitoring of energy meters from Excel configuration</p>
    </header>

    <section class="flex flex-wrap items-center justify-between gap-3 bg-slate-950/60 border-b border-slate-800 px-4 py-3">
      <div class="flex items-center gap-2 text-sm">
        <span id="connectionIndicator" class="w-3 h-3 rounded-full bg-red-500"></span>
        <span id="connectionStatus" class="text-slate-300">Connecting...</span>
      </div>
      <div id="lastUpdate" class="text-sm text-slate-400">Last Update: Loading...</div>
      <div id="utilitiesCount" class="text-sm text-slate-400">Utilities: 0</div>
      <div id="monitoringCount" class="text-sm text-slate-400">Live Monitoring: 0</div>
      <div class="flex items-center gap-2 text-sm text-slate-400">
        <label for="monitorIntervalInput">Polling (ms):</label>
        <input id="monitorIntervalInput" type="number" min="50" step="50" class="w-24 rounded-md bg-slate-800 border border-slate-700 px-2 py-1 text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500" />
      </div>
      <button id="refreshAllBtn" onclick="refreshAll()" class="inline-flex items-center gap-2 rounded-md bg-blue-600 px-3 py-2 text-sm font-semibold text-white shadow hover:bg-blue-500 active:bg-blue-700">üîÑ Refresh All</button>
    </section>

    <main id="utilitiesGrid" class="p-5">
      <div class="text-center text-slate-400 py-8">
        <h3 class="font-medium text-slate-200">Loading utilities...</h3>
        <p>Please wait while we load the configuration from Excel files.</p>
      </div>
    </main>
  </div>

  <script>
    let isRefreshing = false;
    let monitoringIntervals = {};
    let autoStartMonitoring = true;
    let didAutoStartMonitoring = false;

    let monitorIntervalMs = Number(localStorage.getItem('monitorIntervalMs') || {{ monitor_interval_ms|default(500) }});
    const intervalInput = document.getElementById('monitorIntervalInput');
    intervalInput.value = monitorIntervalMs;
    intervalInput.addEventListener('change', () => {
      const v = Math.max(50, Number(intervalInput.value) || {{ monitor_interval_ms|default(500) }});
      monitorIntervalMs = v;
      localStorage.setItem('monitorIntervalMs', String(v));
      restartAllMonitoringIntervals();
      updateMonitorStatusLabels();
    });

    document.addEventListener('DOMContentLoaded', () => { refreshAll(); });
    window.addEventListener('beforeunload', () => { Object.values(monitoringIntervals).forEach(i => clearInterval(i)); });

    function restartAllMonitoringIntervals() {
      Object.keys(monitoringIntervals).forEach(utilityId => {
        clearInterval(monitoringIntervals[utilityId]);
        monitoringIntervals[utilityId] = setInterval(async () => {
          try { await refreshUtility(utilityId, null); } catch (e) { console.error(e) }
        }, monitorIntervalMs);
      });
    }
    function updateMonitorStatusLabels() {
      document.querySelectorAll('.monitor-status').forEach(el => { el.textContent = `üî¥ Live Monitoring Active (${monitorIntervalMs} ms)`; });
      document.querySelectorAll('.monitor-toggle').forEach(btn => { if (!btn.classList.contains('active')) btn.title = `Start continuous monitoring (${monitorIntervalMs} ms)`; });
    }

    async function refreshAll() {
      if (isRefreshing) return; isRefreshing = true;
      const btn = document.getElementById('refreshAllBtn'); if (btn) { btn.disabled = true; btn.textContent = 'üîÑ Reloading Config & Refreshing...'; }
      try {
        const resp = await fetch('/api/refresh_all');
        const data = await resp.json();
        if (data.success) updateUI({ readings: data.readings, last_update: data.timestamp, connection_status: `Connected (${data.utilities_count}/${data.utilities_count} utilities)` });
      } catch (e) {
        console.error('Error refresh all', e);
      } finally {
        isRefreshing = false; if (btn) { btn.disabled = false; btn.textContent = 'üîÑ Refresh All'; }
      }
    }

    function getStatusClass(status) { if (status === 'OK') return 'text-emerald-400'; if (status === 'PARTIAL') return 'text-amber-400'; return 'text-red-400'; }

    function createRegisterBadge(reg, category) {
      const ok = reg.status === 'OK';
      const palette = ok ? 'border-slate-700 bg-slate-800' : 'border-red-700 bg-red-900/40';
      return `
        <div class="register-badge ${category} inline-flex flex-col items-center justify-center rounded-lg border ${palette} px-3 py-2 text-center min-w-[120px]">
          <div class="register-name text-slate-200 text-xs font-semibold mb-1">${reg.description}</div>
          <div class="register-measure flex items-baseline gap-1">
            <span class="register-value text-slate-100 text-base font-bold">${reg.value}</span>
            <span class="register-unit text-slate-400 text-xs">${reg.unit || ''}</span>
          </div>
        </div>
      `;
    }

    function renderSingleRow(utilityData) {
      const regs = Object.values(utilityData.registers || {});
      let totalKW = 0;
      regs.forEach(r => {
        const val = parseFloat(r.value);
        if (!isNaN(val) && r.status === 'OK') {
          const unit = (r.unit || '').toLowerCase();
          const cat = (r.category || '').toLowerCase();
          const desc = (r.description || '').toLowerCase();
          const isActivePower = (cat.includes('power') && !cat.includes('factor')) || (desc.includes('active') && desc.includes('power'));
          const isEnergy = cat.includes('energy') || unit.includes('wh');
          if (!isEnergy && isActivePower) {
            if (unit.includes('kw')) totalKW += val; else if (unit.includes('w')) totalKW += (val / 1000.0);
          }
        }
      });
      const grouped = { current: [], power_factor: [], voltage: [], other: [] };
      regs.forEach(r => { const c=(r.category||'other').toLowerCase(); if (c.includes('current')) grouped.current.push(r); else if (c.includes('power_factor')||c==='pf'||c==='cosphi') grouped.power_factor.push(r); else if (c.includes('voltage')) grouped.voltage.push(r); else grouped.other.push(r); });
      let html = '<div class="registers-container"><div class="registers-grid flex gap-3 overflow-x-auto whitespace-nowrap">';
      if (totalKW > 0) html += `
        <div class="register-badge energy inline-flex flex-col items-center justify-center rounded-lg border border-emerald-700 bg-emerald-900/40 px-3 py-2 text-center min-w-[140px]">
          <div class="register-name text-emerald-200 text-xs font-semibold mb-1">Total Active Power</div>
          <div class="register-measure flex items-baseline gap-1">
            <span class="register-value text-emerald-100 text-base font-bold">${totalKW.toFixed(3)}</span>
            <span class="register-unit text-emerald-300 text-xs">kW</span>
          </div>
        </div>`;
      grouped.current.forEach(r => { html += createRegisterBadge(r, 'current'); });
      grouped.power_factor.forEach(r => { html += createRegisterBadge(r, 'power_factor'); });
      grouped.voltage.forEach(r => { html += createRegisterBadge(r, 'voltage'); });
      grouped.other.forEach(r => { html += createRegisterBadge(r, 'other'); });
      html += '</div></div>';
      return html;
    }

    function updateUI(data) {
      const indicator = document.getElementById('connectionIndicator');
      const status = document.getElementById('connectionStatus');
      const lastUpdate = document.getElementById('lastUpdate');
      if (data.connection_status && data.connection_status.includes('Connected')) { indicator.classList.remove('bg-red-500'); indicator.classList.add('bg-emerald-500'); status.textContent = data.connection_status; } else { indicator.classList.remove('bg-emerald-500'); indicator.classList.add('bg-red-500'); status.textContent = data.connection_status || 'Disconnected'; }
      lastUpdate.textContent = `Last Update: ${data.last_update || 'Never'}`;

      const grid = document.getElementById('utilitiesGrid');
      if (!data.readings || Object.keys(data.readings).length === 0) {
        grid.innerHTML = '<div class="text-center text-slate-400 py-8"><h3 class="font-medium text-slate-200">No data available</h3><p>Polling devices... Please wait.</p></div>';
        return;
      }
      let html = '';
      for (const [utilityId, utilityData] of Object.entries(data.readings)) {
        const statusClass = getStatusClass(utilityData.status);
        const isMonitoring = monitoringIntervals.hasOwnProperty(utilityId);
        html += `
          <div class="bg-slate-900 border border-slate-800 rounded-xl shadow mb-4" id="utility-${utilityId}">
            <div class="bg-slate-800/80 border-b border-slate-800 px-4 py-3 flex items-center justify-between">
              <div class="utility-info">
                <h3 class="text-slate-100 text-base font-semibold">${utilityData.name}</h3>
                <div class="text-slate-400 text-sm">Cabinet ${utilityData.cabinet} | Node ${utilityData.node} | ${utilityData.ip_address}</div>
                <div class="${statusClass} text-sm">${utilityData.status}</div>
                <div class="text-slate-500 text-xs">${utilityData.timestamp || ''}</div>
                ${isMonitoring ? '<div class="monitor-status text-red-400 text-xs font-semibold mt-1">üî¥ Live Monitoring Active (' + monitorIntervalMs + ' ms)</div>' : ''}
              </div>
              <div class="flex items-center gap-2">
                <button class="refresh-btn inline-flex items-center gap-1 rounded-md bg-emerald-600 hover:bg-emerald-500 active:bg-emerald-700 px-3 py-1.5 text-sm font-semibold text-white" onclick="refreshUtility('${utilityId}', this)">üîÑ Refresh</button>
                <button class="monitor-toggle ${isMonitoring ? 'active' : ''} inline-flex items-center gap-1 rounded-md ${isMonitoring ? 'bg-red-600 hover:bg-red-500' : 'bg-slate-600 hover:bg-slate-500'} active:bg-slate-700 px-3 py-1.5 text-sm font-semibold text-white" onclick="toggleMonitoring('${utilityId}', this)" title="${isMonitoring ? 'Stop continuous monitoring' : 'Start continuous monitoring (' + monitorIntervalMs + ' ms)'}">${isMonitoring ? '‚èπ Stop' : 'üî¥ Monitor'}</button>
              </div>
            </div>
            ${renderSingleRow(utilityData)}
          </div>`;
      }
      grid.innerHTML = html;
      if (autoStartMonitoring && !didAutoStartMonitoring && data && data.readings) {
        Object.keys(data.readings).forEach(utilityId => {
          const btn = document.querySelector(`#utility-${utilityId} .monitor-toggle`);
          if (btn && !monitoringIntervals.hasOwnProperty(utilityId)) toggleMonitoring(utilityId, btn);
        });
        didAutoStartMonitoring = true;
      }
      updateMonitoringCount();
    }

    async function refreshUtility(utilityId, button) {
      if (button) { button.disabled = true; button.textContent = 'üîÑ Loading...'; }
      try {
        const response = await fetch(`/api/refresh_utility/${utilityId}`);
        const data = await response.json();
        if (data.success) {
          const readingsResponse = await fetch('/api/readings');
          const allData = await readingsResponse.json();
          updateUI(allData);
        }
      } catch (e) { console.error('Error refreshing utility', utilityId, e); }
      finally { if (button) { button.disabled = false; button.textContent = 'üîÑ Refresh'; } }
    }

    function toggleMonitoring(utilityId, button) {
      const active = monitoringIntervals.hasOwnProperty(utilityId);
      const card = document.getElementById(`utility-${utilityId}`);
      const info = card ? card.querySelector('.utility-info') : null;
      if (active) {
        clearInterval(monitoringIntervals[utilityId]); delete monitoringIntervals[utilityId];
        if (button) { button.className = button.className.replace('bg-red-600','bg-slate-600'); button.textContent = 'üî¥ Monitor'; button.title = `Start continuous monitoring (${monitorIntervalMs} ms)`; button.classList.remove('active'); }
        const ms = card.querySelector('.monitor-status'); if (ms) ms.remove();
      } else {
        if (button) { button.classList.add('active'); button.className = button.className.replace('bg-slate-600','bg-red-600'); button.textContent = '‚èπ Stop'; button.title = 'Stop continuous monitoring'; }
        if (info && !info.querySelector('.monitor-status')) {
          const ms = document.createElement('div'); ms.className = 'monitor-status text-red-400 text-xs font-semibold mt-1'; ms.textContent = 'üî¥ Live Monitoring Active (' + monitorIntervalMs + ' ms)'; info.appendChild(ms);
        }
        monitoringIntervals[utilityId] = setInterval(async () => { try { await refreshUtility(utilityId, null); } catch (e) { console.error(e); } }, monitorIntervalMs);
      }
      updateMonitoringCount();
    }

    function updateMonitoringCount() {
      const n = Object.keys(monitoringIntervals).length; const el = document.getElementById('monitoringCount');
      if (el) { el.textContent = `Live Monitoring: ${n}`; el.className = 'text-sm ' + (n>0 ? 'text-red-400' : 'text-slate-400'); }
    }
  </script>
</body>
</html>

